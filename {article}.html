<!--TEMPLATE mustache-->

{{% partial /_layout }}
{{% partial /_nav }}
{{% import {article} from 'ðŸ”—' }}

{{< layout}}

{{$title}}{{article.title}}{{/title}}

{{$content}}

<div class="columns">
    <div class="column is-one-fifth is-hidden-mobile">
        {{>nav}}
    </div>
    <div class="column">
        <article>
            <header>
                <h1>{{article.title}} {{#article.beta}}<span class="badge is-danger">Beta</span>{{/article.beta}}</h1>

                {{#article.summary}}<p>{{article.summary}}</p>{{/article.summary}}
            </header>

            {{{article.get.content}}}

            <footer>
                <div class="suggestion"><span>Any suggestion or typo? </span>
                    <a class="suggestion-edit-link"
                       href="https://github.com/stacklane/docs/edit/master/ðŸ—„/Article/{{article.uid}}.md"
                       target="_blank" rel="noreferrer noopener nofollow">Edit on GitHub</a></div>
            </footer>
        </article>
    </div>
    <div class="column is-narrow is-hidden-tablet-only is-hidden-mobile">
        <div id="toc"></div>
    </div>
</div>

<template id="more-modal">
    <div class="modal is-active">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title"></p>
                <button class="delete" aria-label="close"></button>
            </header>
            <article class="modal-card-body">

            </article>
        </div>
    </div>
</template>

<script>
    /* TOC */
    $ready(()=>{
        var html = '';

        document.querySelectorAll('article > h1').forEach((e)=>{
            if (e.id) {
                var title = e.innerText;
                html += '<li><a href="#' + e.id + '" data-scroll>' + title + '</a></li>';
            }
        });

        if (html.length > 0) $get('toc').innerHTML = '<ul>' + html + '</ul>';
    });

    /* .more */
    $ready(()=>{
        let article = document.querySelector('article');

        document.querySelectorAll('article > .more').forEach((e)=>{
            let moreContent = e.innerHTML;
            let sibling = e.previousElementSibling;
            let count = 0;

            let contentItems = new Array();
            contentItems.push(moreContent);

            while (sibling.tagName != 'H3' && sibling.tagName != 'H2'){
                contentItems.push(sibling.outerHTML);
                sibling = sibling.previousElementSibling;
                count++;
                if (count > 10) return; // Did not find an H3/H2
            }

            let title = sibling.innerHTML;
            let content = contentItems.reverse().join('\n');

            let button = document.createElement('span');
            button.innerText = 'More...';
            button.setAttribute('class', 'button is-dark is-small is-rounded');
            sibling.appendChild(button);

            button.addEventListener('click', ()=>{
                let template = document.querySelector('#more-modal');
                let modal = document.importNode(template.content, true);
                let modalElement = modal.querySelector('.modal');
                let modalContent = modal.querySelector('.modal-card-body');
                let modalTitle = modal.querySelector('.modal-card-title');
                let modalClose = modal.querySelector('.modal-card-head .delete');
                modalContent.innerHTML = content;
                modalTitle.innerHTML = title;
                modalClose.addEventListener('click', ()=>modalElement.remove());
                article.appendChild(modal);
            });

            e.remove();
        });
    });

    /* does not span sections..
    $ready(function() {
        if (typeof Gumshoe !== 'undefined') {
            var height = $get('nav').getBoundingClientRect().height;
            new Gumshoe('#toc a', {
                navClass: 'is-active', // applied to the nav list item
                //contentClass: 'is-active', // applied to the content
                offset: function () {
                    return height;
                },
                reflow: true
            });
        }
    });*/
</script>

{{/content}}
{{/layout}}